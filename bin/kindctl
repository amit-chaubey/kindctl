#!/usr/bin/env bash

set -euo pipefail

REPO_ROOT="$(cd "$(dirname "${BASH_SOURCE[0]}")/.." && pwd)"

# shellcheck source=../scripts/lib/log.sh
source "${REPO_ROOT}/scripts/lib/log.sh"
# shellcheck source=../scripts/lib/deps.sh
source "${REPO_ROOT}/scripts/lib/deps.sh"
# shellcheck source=../scripts/lib/kind.sh
source "${REPO_ROOT}/scripts/lib/kind.sh"

KINDCTL_VERSION="0.1.0"

usage() {
  cat <<'EOF'
kindctl - local Kubernetes clusters with kind

Usage:
  kindctl [flags] <command>

Commands:
  up           Create the cluster (or use existing)
  down         Delete the cluster
  status       Show cluster status and nodes
  nodes        List kind node containers
  kubeconfig   Print kubeconfig path
  version      Print version
  help         Show help

Use kubectl for pods, nodes, apply, etc.:
  export KUBECONFIG="$(kindctl kubeconfig)"
  kubectl get nodes
  kubectl get pods -A

Flags (before command):
  --name <name>       Cluster name (default: kindctl)
  --config <path>     Kind cluster config (default: kind/cluster.yaml)
  --kubeconfig <path> Where to write kubeconfig (default: .kube/kubeconfig-<name>)

Examples:
  kindctl up
  kindctl status
  export KUBECONFIG="$(kindctl kubeconfig)" && kubectl get nodes
EOF
}

require_file() {
  local path="$1"
  [[ -f "${path}" ]] || kindctl_die "File not found: ${path}"
}

main() {
  local cluster_name="kindctl"
  local config_path="${REPO_ROOT}/kind/cluster.yaml"
  local kubeconfig_path=""

  # Parse global flags only (before command).
  while [[ $# -gt 0 ]]; do
    case "$1" in
      --name)
        cluster_name="${2:-}"; shift 2 || true
        ;;
      --config)
        config_path="${2:-}"; shift 2 || true
        ;;
      --kubeconfig)
        kubeconfig_path="${2:-}"; shift 2 || true
        ;;
      -h|--help)
        usage
        exit 0
        ;;
      *)
        break
        ;;
    esac
  done

  [[ -n "${cluster_name}" ]] || kindctl_die "--name cannot be empty"
  [[ -n "${config_path}" ]] || kindctl_die "--config cannot be empty"

  if [[ -z "${kubeconfig_path}" ]]; then
    kubeconfig_path="$(kindctl_kubeconfig_path_for "${cluster_name}")"
  fi

  local cmd="${1:-help}"
  shift || true

  # Built-in commands.
  case "${cmd}" in
    up)
      kindctl_banner
      kindctl_require_docker
      kindctl_require_kind
      kindctl_require_kubectl
      require_file "${config_path}"
      kindctl_kind_up "${cluster_name}" "${config_path}" "${kubeconfig_path}"
      kindctl_log "Done. Run: export KUBECONFIG=\"\$(kindctl kubeconfig)\" && kubectl get nodes"
      ;;
    down)
      kindctl_banner
      kindctl_require_kind
      kindctl_kind_down "${cluster_name}" "${kubeconfig_path}"
      ;;
    status)
      kindctl_banner
      kindctl_require_kind
      kindctl_require_kubectl
      kindctl_kind_status "${cluster_name}" "${kubeconfig_path}"
      ;;
    nodes)
      kindctl_require_kind
      kindctl_kind_nodes "${cluster_name}"
      ;;
    kubeconfig)
      echo "${kubeconfig_path}"
      ;;
    version)
      echo "${KINDCTL_VERSION}"
      ;;
    help|--help|-h|"")
      usage
      ;;
    *)
      kindctl_die "Unknown command: ${cmd}. Use: kindctl help. For pods/nodes run: export KUBECONFIG=\"\$(kindctl kubeconfig)\" && kubectl get nodes"
      ;;
  esac
}

main "$@"

